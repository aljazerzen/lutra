type Program = {
  externals = [ExternalSymbol],
  main = Expr,
}

type ExternalSymbol = {
  id = text,
}

type Expr = {
  kind = ExprKind,
  ty = Ty,
}

type ExprKind = enum {
  Pointer = Sid,
  Literal = Literal,
  Call = Call,
  Function = Function,
  `Tuple` = [Expr],
  Array = [Expr],
  TupleLookup = TupleLookup,
  ArrayLookup = ArrayLookup,
  Binding = Binding,
}

## Symbol id.
## - 0b00xxxxxx - external
## - 0b01xxxxxx - local bindings
## - 0b10xxxxxx - function scopes
## - 0b11xxxxxx - unused
# TODO: make this u32
@(derive ["Debug", "Clone", "Copy", "PartialEq", "Eq", "Hash"])
type Sid = int

@(derive ["Debug", "Clone", "PartialEq"])
type Literal = enum {
  Int = int,
  Float = float,
  Bool = bool,
  Text = text,
}

type Call = {
  function = Expr,
  layout = [int],
  args = [Expr],
}

type Function = {
  symbol_ns = Sid,

  # can contain function parameters prefixed with symbol_ns
  body = Expr,
}

type TupleLookup = {
  base = Expr,
  offset = int,
}

type ArrayLookup = {
  base = Expr,
  offset = int,
}

type Binding = {
  symbol = Sid,
  expr = Expr,
  main = Expr,
}

type Ty = {
  kind = TyKind,
  layout = TyLayout,
}

type TyKind = enum {
  Primitive = PrimitiveSet,

  Tuple = [TyTupleField],

  Array = Ty,

  Enum = [TyEnumVariant],

  Function = TyFunction,
}

@(derive ["Debug", "Clone", "Copy", "PartialEq", "Eq", "Hash"])
type PrimitiveSet = enum {
  int,
  float,
  bool,
  text,
}

type TyTupleField = {
  name = enum { None, Some = text},
  ty = Ty,
}

type TyEnumVariant = {
  name = text,
  ty = Ty,
}

type TyLayout = {
  head_size = int,
  variants_recursive = [int]
}

type TyFunction = {
  params = [Ty],
  body = Ty
}
