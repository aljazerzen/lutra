# --- [ Complex tests ] ---
#
# This file contains tests for the language itself.
# It is read by the main.rs and exposed as a series of cargo-compatible tests.
# A test consists of:
#
#    #  === <test name>       (test name)
#    # skip: interpreter       (optional)
#    # skip: postgres          (optional)
#    <lutra project code>
#    # <                   (input marker)
#    <input>                   (optional)
#    # >                  (output marker)
#    <output>

# === chinook_00

module chinook {
  import std::filter
  import std::index
  import std::or_default

  type Album: {id: int64, title: text}

  func get_albums(): [Album] -> [
    {id = 3, title = "Hello world!"},
    {id = 5, title = "Foo"},
  ]

  func get_album_by_id(album_id: int64): Album -> (
      get_albums()
      | filter(func (this: Album) -> this.id == album_id)
      | index(0)
      | or_default()
    )
  }

module box_office {
  import std::filter
  import std::index
  import std::or_default

  type Invoice: {id: int64, total: float64}

  func get_album_sales(): [Invoice] -> [
    {id = 3, total = 3.6},
    {id = 3, total = 3.1},
    {id = 5, total = 5.2},
  ]

  func get_album_sales_by_id(album_id: int64): Invoice -> (
    get_album_sales()
    | filter(func (this: Invoice) -> this.id == album_id)
    | index(0)
    | or_default()
  )
}

func main() -> {
  chinook::get_albums(),
  chinook::get_album_by_id(3),
  box_office::get_album_sales_by_id(3),
}

# >
{
  [
    {
      id = 3,
      title = "Hello world!",
    },
    {
      id = 5,
      title = "Foo",
    },
  ],
  {
    id = 3,
    title = "Hello world!",
  },
  {
    id = 3,
    total = 3.6,
  },
}


# === chinook_01
module chinook {
  type Album: {id: int64, title: text}

  func get_album(): Album -> (
    {id = 3, title = "Hello world!"}
  )
}

func main() -> {
  5: int16,
  chinook::get_album()
}

# >
{
  5,
  {
    id = 3,
    title = "Hello world!",
  },
}


# === chinook_02
module chinook {
  type Album: {id: int64, title: text}

  func get_albums(): [Album] -> [
    {id = 3, title = "Hello world!"},
    {id = 5, title = "Foo"},
  ]

  func get_album_by_id(album_id: int64): Album -> (
    get_albums()
    | std::filter(func (this: Album) -> this.id == album_id)
    | std::index(0)
    | std::or_default()
  )
}

func main() -> {chinook::get_album_by_id(3)}

# >
{
  {
    id = 3,
    title = "Hello world!",
  },
}


# === chinook_03
module chinook {
  type Album: {title: text, genre_id: int64}
  type Genre: {id: int64, name: text}

  func get_genres(): [Genre] -> [
    {id = 1, name = "Rock"},
    {id = 2, name = "EDM"},
  ]

  func get_albums(): [Album] -> [
    {title = "Suck It and See", genre_id = 1},
    {title = "Random Access Memories", genre_id = 2},
    {title = "AM", genre_id = 1},
  ]

  func get_albums_by_genre(genre_id: int64): [Album] -> (
    get_albums()
    | std::filter(func (this: Album) -> this.genre_id == genre_id)
  )
}

import chinook as c

func main() -> (
  c::get_genres()
  | std::map(func (this: c::Genre) -> {
    name = this.name,
    albums = (
      c::get_albums_by_genre(this.id)
      | std::map(func (this: c::Album) -> this.title)
    ),
  })
)
# >
[
  {
    name = "Rock",
    albums = [
      "Suck It and See",
      "AM",
    ],
  },
  {
    name = "EDM",
    albums = [
      "Random Access Memories",
    ],
  },
]

# === compounding_interest_00

type Accumulator: {time: int32, repayment: float64, dept: float64}

const payments: [{time: int32, amount: float64}] = [
  {3, 10_000.0}, # no fmt
  {5, 10_000.0},
  {7, 10_000.0},
  {9, 11_200.0},
  {13, 10_000.0},
]

func main() -> (
  payments
  | std::fold(
    {time = 0, repayment = 0.0, dept = 50000.0},
    func (acc: Accumulator, payment: {time: int32, amount: float64}) -> (
      {
        time = payment.time,
        repayment = payment.amount,
        dept = (
          acc.dept
          * std::math::pow(1.0 + 0.05 / 12.0, payment.time - acc.time | std::to_float64)
          - payment.amount
        ),
      }
    ),
  )
)
# >
{
  time = 13,
  repayment = 10000.0,
  dept = 373.8299254002286,
}


# === compounding_interest_01

type Payment: {time: int32, amount: float64}

type State: {
  time: int32, dept: float64, last_payment: Payment,
}

const payments: [Payment] = [
  {3, 10000.0}, # no fmt
  {5, 10000.0},
  {7, 10000.0},
  {9, 11200.0},
  {13, 10373.0},
]

func apply_time(state: State, time: int32): State -> {
  time = time,
  dept = (
    state.dept
    * std::math::pow(1.0 + 0.05 / 12.0, time - state.time | std::to_float64)
  ),
  last_payment = state.last_payment,
}

func apply_payment(state: State, payment: Payment): State -> {
  time = state.time, dept = state.dept - payment.amount, last_payment = payment,
}

func simulate_dept(at_time: int32) -> (
  payments
  | std::filter(func (p: Payment) -> p.time <= at_time)
  | std::fold(
    {time = 0, dept = 50000.0, last_payment = std::default()}: State,
    func (state: State, payment: Payment) -> (
      state | apply_time(payment.time) | apply_payment(payment)
    ),
  )
  | apply_time(at_time)
)

func main() -> [10, 15] | std::map(func (x) -> simulate_dept(x))

# >
[
  {
    time = 10,
    dept = 10245.230201028651,
    last_payment = {
      time = 9,
      amount = 11200.0,
    },
  },
  {
    time = 15,
    dept = 0.8368558536575957,
    last_payment = {
      time = 13,
      amount = 10373.0,
    },
  },
]